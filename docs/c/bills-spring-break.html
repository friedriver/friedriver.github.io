<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Card</title>
    <style>
      @font-face {
        font-family: "Marker-Felt-Wide";
        src: url("/i/Marker-Felt-Wide.ttf");
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .envelope-container {
        position: relative;
        width: 400px;
        height: 400px;
        perspective: 1000px;
      }

      /* The card */
      .card {
        position: absolute;
        width: 340px;
        height: 240px;
        left: 30px;
        bottom: 30px;
        z-index: 2;
        animation:
          slideOut 4s ease-in-out 0.5s forwards,
          cardZ 4s ease-in-out 0.5s forwards;
        transform-origin: center bottom;
        perspective: 1000px;
      }

      .card-front {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .card-front img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        background: #f6f6f5;
      }

      /* Message panel that folds down */
      .message-panel {
        position: absolute;
        width: 100%;
        height: 200px;
        top: 100%;
        left: 0;
        background: #f6f6f5;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transform-origin: top center;
        transform: rotateX(-90deg);
        animation:
          foldDown 4s ease-in-out 0.5s forwards,
          messagePanelZ 4s ease-in-out 0.5s forwards;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: -1;
      }

      .message-panel p {
        font-family: "Marker-Felt-Wide", serif;
        font-size: 18px;
        color: #333;
        text-align: center;
        line-height: 1.6;
      }

      /* Envelope back */
      .envelope-back {
        position: absolute;
        width: 400px;
        height: 280px;
        bottom: 0;
        background: #c9a86c;
        border-radius: 0 0 15px 15px;
        z-index: 1;
      }

      /* Envelope flap (opens) */
      .envelope-flap-container {
        position: absolute;
        width: 400px;
        height: 160px;
        top: 120px;
        z-index: 5;
        animation: flapZ 4s ease-in-out 0.5s forwards;
      }

      .envelope-flap {
        position: absolute;
        width: 0;
        height: 0;
        top: 0;
        border-left: 200px solid transparent;
        border-right: 200px solid transparent;
        border-top: 160px solid #b8956a;
        transform-origin: top center;
        animation: openFlap 4s ease-in-out 0.5s forwards;
      }

      /* Envelope front */
      .envelope-front {
        position: absolute;
        width: 400px;
        height: 280px;
        bottom: 0;
        background: #ddb87a;
        border-radius: 0 0 15px 15px;
        z-index: 3;
        clip-path: polygon(0 0%, 50% 45%, 100% 0%, 100% 100%, 0 100%);
      }

      .envelope-front::before {
        content: "";
        position: absolute;
        width: 400px;
        height: 280px;
        background: linear-gradient(to bottom, #c9a050 0%, #ddb87a 15%);
        clip-path: polygon(0 0%, 50% 45%, 100% 0%, 100% 100%, 0 100%);
      }

      /* Inner shadow for depth */
      .envelope-inner {
        position: absolute;
        width: 380px;
        height: 260px;
        bottom: 10px;
        left: 10px;
        background: #b8956a;
        border-radius: 0 0 10px 10px;
        z-index: 0;
      }

      /* Flap opening animation */
      @keyframes openFlap {
        0%,
        5% {
          transform: rotateX(0deg);
        }
        25%,
        100% {
          transform: rotateX(-110deg);
        }
      }

      /* Flap z-index animation */
      @keyframes flapZ {
        0%,
        10% {
          z-index: 5;
        }
        20%,
        100% {
          z-index: 1;
        }
      }

      /* Card slides out after flap opens */
      @keyframes slideOut {
        0%,
        25% {
          transform: translateY(0);
        }
        50%,
        100% {
          transform: translateY(-320px);
        }
      }

      /* Message panel folds down */
      @keyframes foldDown {
        0%,
        55% {
          transform: rotateX(-90deg);
        }
        80%,
        100% {
          transform: rotateX(0deg);
        }
      }

      /* Message panel z-index: start behind card, come forward when extended */
      @keyframes messagePanelZ {
        0%,
        55% {
          z-index: -1;
        }
        75%,
        100% {
          z-index: 10;
        }
      }

      /* Card z-index: raise above envelope when message panel extends */
      @keyframes cardZ {
        0%,
        55% {
          z-index: 2;
        }
        75%,
        100% {
          z-index: 10;
        }
      }
      /* Paused state - animations wait for click */
      .paused .card,
      .paused .message-panel,
      .paused .envelope-flap-container,
      .paused .envelope-flap {
        animation-play-state: paused;
      }

      /* Click overlay */
      .click-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        cursor: pointer;
      }

      .click-overlay span {
        background: white;
        padding: 20px 40px;
        border-radius: 10px;
        font-family: Georgia, serif;
        font-size: 24px;
        color: #333;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      /* Confetti */
      .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        top: 50%;
        left: 50%;
        pointer-events: none;
        opacity: 0;
      }

      .confetti.animate {
        animation: confetti-fall 2s ease-out forwards;
      }

      @keyframes confetti-fall {
        0% {
          opacity: 1;
          transform: translate(var(--x), var(--y)) rotate(0deg) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(var(--x-end), var(--y-end))
            rotate(var(--rotation)) scale(0.5);
        }
      }

      #message {
        width: 100%;
        height: 7.5em;
      }
    </style>
  </head>
  <body>
    <div class="click-overlay" id="overlay"><span>Click to Open</span></div>
    <div class="envelope-container paused" id="envelope">
      <div class="envelope-inner"></div>
      <div class="envelope-back"></div>
      <div class="card">
        <div class="card-front">
          <img src="/i/bills-spring-break.png" alt="Congratulations Card" />
        </div>
        <div class="message-panel">
          <span id="save-btn-err"></span>
          <span id="save-btn-ctr">
            <p>
              <textarea id="message">This ain't spring break!</textarea>
            </p>
            <p>
              <button style="width: 100%" id="save-btn">Save</button>
              <script>
                (() => {
                  const pg = "bills-spring-break";
                  document.getElementById("save-btn").onclick = () => {
                    const xhr = new XMLHttpRequest();
                    xhr.open(
                      "GET",
                      `https://api.friedliver.com/sqrunch?message=${encodeURIComponent(document.getElementById("message").value.trim())}&page=${encodeURIComponent(pg)}`,
                      true,
                    );
                    xhr.onreadystatechange = () => {
                      if (xhr.readyState == 4 && xhr.status == 200) {
                        try {
                          const rdata = JSON.parse(xhr.responseText);
                          const url = `https://api.friedliver.com/e/${rdata.url}`;
                          document.getElementById("save-btn-ctr").innerHTML =
                            `<p><a href="${url}" target="_blank" style="color:#667eea;word-break:break-all;">${url}</a></p>
                             <p><button style="width:100%;margin-top:8px;" onclick="navigator.clipboard.writeText('${url}').then(() => this.innerText = 'Copied!')">Copy Link</button></p>`;
                        } catch (e) {
                          document.getElementById("save-btn-err").innerText =
                            "Something went wrong, please refresh and try again";
                        }
                      }
                    };
                    xhr.send();
                  };
                })();
              </script>
            </p>
          </span>
        </div>
      </div>
      <div class="envelope-front"></div>
      <div class="envelope-flap-container">
        <div class="envelope-flap"></div>
      </div>
    </div>
    <audio autoplay>
      <source src="/i/party-in-the-usa-short.mp3" type="audio/mpeg" />
    </audio>

    <script>
      const colors = [
        "#ff6b6b",
        "#ffd93d",
        "#6bcb77",
        "#4d96ff",
        "#ff6bd6",
        "#845ef7",
      ];
      const shapes = ["square", "circle", "triangle"];

      function createConfetti() {
        const confettiCount = 50;

        for (let i = 0; i < confettiCount; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";

          // Random properties
          const color = colors[Math.floor(Math.random() * colors.length)];
          const shape = shapes[Math.floor(Math.random() * shapes.length)];
          const size = Math.random() * 10 + 5;

          // Random explosion direction
          const angle = Math.random() * Math.PI * 2;
          const velocity = Math.random() * 200 + 100;
          const xEnd = Math.cos(angle) * velocity;
          const yEnd = Math.sin(angle) * velocity - 100; // Bias upward
          const rotation = Math.random() * 720 - 360;

          confetti.style.width = size + "px";
          confetti.style.height = size + "px";
          confetti.style.backgroundColor = color;
          confetti.style.setProperty("--x", "0px");
          confetti.style.setProperty("--y", "0px");
          confetti.style.setProperty("--x-end", xEnd + "px");
          confetti.style.setProperty("--y-end", yEnd + "px");
          confetti.style.setProperty("--rotation", rotation + "deg");

          if (shape === "circle") {
            confetti.style.borderRadius = "50%";
          } else if (shape === "triangle") {
            confetti.style.width = "0";
            confetti.style.height = "0";
            confetti.style.backgroundColor = "transparent";
            confetti.style.borderLeft = size / 2 + "px solid transparent";
            confetti.style.borderRight = size / 2 + "px solid transparent";
            confetti.style.borderBottom = size + "px solid " + color;
          }

          document.body.appendChild(confetti);

          // Trigger animation
          requestAnimationFrame(() => {
            confetti.classList.add("animate");
          });

          // Remove after animation
          setTimeout(() => {
            confetti.remove();
          }, 2000);
        }
      }

      // Start on click
      document.getElementById("overlay").addEventListener("click", function () {
        // Hide overlay
        this.style.display = "none";
        // Unpause animations
        document.getElementById("envelope").classList.remove("paused");
        // Play audio if present
        const audio = document.querySelector("audio");
        if (audio) audio.play();
        // Fire confetti when flap opens (synced with animation)
        setTimeout(createConfetti, 650);
      });
    </script>
  </body>
</html>
